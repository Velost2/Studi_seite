<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UX-Experiment – Persuasive Design</title>
  <link rel="stylesheet" href="hmm.css" />
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "t4h7v8a2dt");
</script>
  <script>
(function waitClarity(tries=0){
  if (typeof window.clarity === "function") {
    console.log("[Clarity] ready");
  } else if (tries < 20) {
    setTimeout(()=>waitClarity(tries+1), 300);
  } else {
    console.warn("[Clarity] not detected after ~6s");
  }
})();
</script>

  <script>
    window.COLLECT_URL = "/.netlify/functions/collect";
  </script>
</head>
<body>
  <div class="container">
    <header class="header">
      <div>
        <h1 class="title">UX-Experiment-App</h1>
        <p class="subtitle">Wählen Sie intuitiv und aus dem Bauch heraus,
          es gibt keine richtigen oder falschen Antworten.<br> 
          Ihre Angaben bleiben dabei vollständig anonym</p>
      </div>
      <div class="header-actions">
        <button id="btn-back" type="button" class="btn btn-outline hidden">Zurück</button>
        <select id="jump-select" class="jump"></select>
        <button id="jump-go" type="button" class="btn btn-outline">Gehe</button>
      </div>
    </header>

    <div class="progress"><div id="progress" class="progress__bar" style="width:0%"></div></div>

    <!-- INTRO -->
    <section id="screen-intro" class="card">
      <h2>Teilnahme & Datenschutz</h2>
      <ul class="list">
        <li>Es werden nur anonyme Interaktionsdaten gespeichert (Klicks, Zeiten, Auswahl).</li>
        <li>Keine IP/Browserdaten, keine Personenbezüge.</li>
        <li>Die Daten werden erst beim Klick auf Ergebnisse senden übertragen.</li>
      </ul>
      <label class="checkbox-row">
        <input type="checkbox" id="consent" />
        <span>Ich stimme der anonymen Datenerhebung zu.</span>
      </label>
      <div class="row">
        <button id="btn-start" class="btn btn-disabled" disabled>Start</button>
      </div>
    </section>

    <!-- EXP 1: Proximity/Grouping -->
    <section id="screen-exp1" class="card hidden">
      <h2>Schritt 1</h2>
      <p class="hint">Aufgabe: Wählen Sie ein Paket. <br>
        (Diese Angaben sind nur Platzhalter, es geht um die Gestaltung, Sie werden nicht zum Kauf o.ä. verpflichtet.)
      </p>
      <div id="exp1-cards" class="grid grid-3"></div>
    </section>

    <!-- EXP 2: Buttonform/-kontrast -->
    <section id="screen-exp2" class="card hidden">
      <h2>Schritt 2</h2>
      <p class="hint">Aufgabe: Klicken Sie einen Weiter-Button.</p>
      <div class="row gap">
        <button id="exp2-left" type="button" class="btn">Weiter</button>
        <button id="exp2-right" type="button" class="btn">Weiter</button>
      </div>
    </section>

    <!-- EXP 3: Social Proof -->
    <section id="screen-exp3" class="card hidden">
      <h2>Schritt 3</h2>
      <p class="hint">Aufgabe: Wählen Sie ein Produkt.<br>
        (Diese Angaben sind nur Platzhalter, es geht um die Gestaltung, Sie werden nicht zum Kauf o.ä. verpflichtet.)
      </p>
      <div id="exp3-banner" class="banner"></div>
      <div id="exp3-grid" class="grid grid-3"></div>
    </section>

    <!-- EXP 4: Shipping Defaults -->
    <section id="screen-exp4" class="card hidden">
      <h2>Schritt 4</h2>
      <p class="hint">Aufgabe: Wählen Sie eine Versandoption und speichern Sie.</p>
      <div id="exp4-options" class="stack gap-sm"></div>
      <div class="row"><button id="exp4-save" type="button" class="btn btn-primary">
        Speichern</button></div>
    </section>

    <!-- EXP 4 Preference: Bevorzugte Versandart -->
    <section id="screen-exp4pref" class="card hidden">
      <h2>Zusatzfrage: Bevorzugte Versandart</h2>
      <p class="hint">Welche Versandoption bevorzugen Sie grundsätzlich?</p>
      <div id="exp4pref-options" class="stack gap-sm"></div>
      <div class="row"><button id="exp4pref-next" type="button" class="btn btn-primary">Weiter</button></div>
    </section>

    <!-- EXP 5: Material & Scarcity -->
    <section id="screen-exp5" class="card hidden">
      <h2>Schritt 5</h2>
      <p class="hint">Wählen Sie ein Paket. <br>
        Alle Pakete sind inhaltlich gleich, bitte wählen Sie nach Gefühl.</p>
      <div id="exp5-grid" class="grid grid-3"></div>
    </section>

    <!-- EXP 2b: CTA Farbe (nur Farbe, beide rund) -->
    <section id="screen-exp2b" class="card hidden">
      <h2>Zusatztest: Buttonfarbe</h2>
      <p class="hint">Aufgabe: Klicken Sie einen Weiter-Button.</p>
      <div class="row gap">
        <button id="exp2b-left" type="button" class="btn btn-pill">Weiter</button>
        <button id="exp2b-right" type="button" class="btn btn-pill">Weiter</button>
      </div>
    </section>

    <!-- EXP 13: CTA Microcopy (als Schritt 8) -->
    <section id="screen-exp13" class="card hidden">
      <h2>Schritt 8</h2>
      <p class="hint">Klicken Sie den Button.</p>
      <div class="row"><button id="exp13-cta" type="button" class="btn btn-primary">Weiter</button></div>
    </section>

    <!-- EXP 6: Single Button -->
    <section id="screen-exp6" class="card hidden">
      <h2>Schritt 6</h2>
      <p class="hint">Klicken Sie den Weiter-Button.</p>
      <div id="exp6-wrap" class="stack" style="align-items:center; gap:16px; min-height:180px; justify-content:center;">
        <div class="row"><button id="exp6-cta" type="button" class="btn btn-primary">Weiter</button></div>
      </div>
    </section>

    <!-- EXP 6b: Confirm + Distance -->
    <section id="screen-exp6chk" class="card hidden">
      <h2>Schritt 7</h2>
      <p class="hint">Bitte die Checkbox bestätigen und dann Weiter klicken.</p>
      <div id="exp6chk-wrap" class="stack" style="min-height:260px;">
        <label class="checkbox-row"><input type="checkbox" id="exp6chk-cb" /> <span>Bitte hier die Checkbox bestätigen</span></label>
        <div class="row"><button id="exp6chk-next" type="button" class="btn btn-primary btn-disabled" disabled>Weiter</button></div>
      </div>
    </section>

    <!-- EXP 8: CTA-Signifier (Icon vs. kein Icon) -->
    

    <!-- EXP 9b: Social Proof (Label oben) -->
    <section id="screen-exp9b" class="card hidden">
      <h2>Schritt 8</h2>
      <p class="hint">Wählen Sie ein Produkt.</p>
      <div id="exp9b-grid" class="grid grid-3"></div>
    </section>

    <!-- EXP 10: CTA-Signifier erneut (Icon vs. kein Icon) -->
    <section id="screen-exp10icon" class="card hidden">
      <h2>Schritt 9</h2>
      <p class="hint">Klicken Sie einen Weiter-Button.</p>
      <div class="row gap">
        <button id="exp10icon-left" type="button" class="btn btn-primary">Weiter</button>
        <button id="exp10icon-right" type="button" class="btn btn-primary">Weiter</button>
      </div>
    </section>

    <!-- EXP 11: Good Continuation (lineare Anordnung) -->
    <section id="screen-exp11gc" class="card hidden">
      <h2>Schritt 10</h2>
      <p class="hint">Wählen Sie die größte Zahl.</p>
      <div id="exp11gc-wrap" class="card soft" style="position:relative; min-height:180px; padding:16px;"></div>
    </section>

    <!-- EXP 12: Figure-Ground (subtile Hervorhebung) -->
    <section id="screen-exp12fg" class="card hidden">
      <h2>Schritt 12</h2>
      <p class="hint">Wählen Sie ein Paket.</p>
      <div id="exp12fg-cards" class="grid grid-3"></div>
    </section>

    <!-- EXP 13: Similarity vs. Dissimilarity / Abstufung der Hervorhebung -->
    <section id="screen-exp12sd" class="card hidden">
      <h2>Schritt 13</h2>
      <p class="hint">Wählen Sie einen Button.</p>
      <div class="row gap" style="justify-content:center;">
        <button id="exp12sd-left"  type="button" class="btn btn-outline">Weiter</button>
        <button id="exp12sd-mid"   type="button" class="btn btn-outline">Weiter</button>
        <button id="exp12sd-right" type="button" class="btn btn-outline">Weiter</button>
      </div>
    </section>

    <!-- EXP 14: Social Proof stark hervorgehoben -->
    <section id="screen-exp14sp" class="card hidden">
      <h2>Schritt 14</h2>
      <p class="hint">Wählen Sie ein Produkt.</p>
      <div id="exp14sp-grid" class="grid grid-3"></div>
    </section>

    <!-- EXP 15: Left Bias mit gleichen Karten (Exp1 Kopie ohne Grouping) -->
    <section id="screen-exp15left" class="card hidden">
      <h2>Schritt 15</h2>
      <p class="hint">Wählen Sie ein Paket.</p>
      <div id="exp15-grid" class="grid grid-3"></div>
    </section>

    <!-- EXP 7: Positionsbias (Reihenfolge/Alignment) -->
    <section id="screen-exp7" class="card hidden">
      <h2>Schritt 7</h2>
      <p class="hint">Wählen Sie eine Karte.</p>
      <div id="exp7-grid" class="grid grid-2"></div>
    </section>

    <!-- EXP 8 entfernt -->

    <!-- Schritte 9–11 entfernt -->

    

    <!-- SURVEY -->
    <section id="screen-survey" class="card hidden">
      <h2>Abschlussfragebogen</h2>
      <p class="hint">Bitte teilen Sie Ihr offenes Feedback zur Nutzung mit.</p>
      <div class="stack gap-sm">
        <label class="label">Offenes Feedback</label>
        <textarea id="openComment" class="input" rows="4" placeholder="Was war gut, was nicht?"></textarea>
      </div>
      <div class="row"><button id="survey-finish" type="button" class="btn btn-primary">Abschließen</button></div>
    </section>

    <!-- DEBRIEF -->
    <section id="screen-debrief" class="card hidden">
      <h2>Vielen Dank</h2>
      <p class="hint">Sitzung beendet. Bitte senden Sie Ihre Ergebnisse.</p>
      <div class="row">
        <button id="btn-submit" type="button" class="btn btn-accent">Ergebnisse senden</button>
      </div>
      <div id="submit-status" class="meta mt"></div>
    </section>

    <!-- Attribution Panel (Overlay) -->
    <div id="attr" class="overlay hidden">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Kurze Einordnung">
        <button id="attr-close" type="button" class="modal__close" aria-label="Schließen"></button>
        <div id="attr-drag" class="modal__drag" aria-hidden="true" title="Zum Verschieben hier ziehen"></div>
        <h3 id="attr-title" class="modal__title">Kurze Einordnung</h3>
        <p class="hint">Was hat Ihre Entscheidung beeinflusst? (Mehrfachauswahl möglich, optional)</p>
        <div id="attr-options" class="chips"></div>
        <textarea id="attr-note" class="input" rows="3" placeholder="Kurze Begründung (optional)"></textarea>
        <div class="row end gap mt">
          <button id="attr-skip" type="button" class="btn btn-outline">Weiter ohne Angabe</button>
          <button id="attr-save" type="button" class="btn btn-primary">Speichern & Weiter</button>
        </div>
      </div>
    </div>
    <button id="attr-reopen" type="button" class="fab hidden" title="Einordnung erneut öffnen">Einordnung</button>

    <footer class="footer">
      <div>Vielen Dank für die Hilfe!</div>
      <!-- Zeit-Anzeige entfernt -->
    </footer>
  </div>

  <script>
    // ===== Utilities =====
    const $ = (sel) => document.querySelector(sel);
    const screens = ["intro","exp1","exp2","exp3","exp4","exp4pref","exp5","exp2b","exp6","exp6chk","exp7","exp9b","exp10icon","exp11gc","exp12fg","exp12sd","exp14sp","exp15left","survey","debrief"];
    const now = () => performance.now();
    const progress = (idx) => {
      const denom = Math.max(1, screens.length - 1);
      $("#progress").style.width = Math.min(100, Math.max(0, (idx/denom)*100)) + "%";
    };
    // Device-aware helpers for wording
    const IS_MOBILE = (()=>{ try { return /Mobi|Android/i.test(navigator.userAgent) || (window.matchMedia && window.matchMedia('(pointer:coarse)').matches) || window.innerWidth < 640; } catch { return false; } })();
    // Simplified wording: just "Position" across devices
    const posLR = ()=> 'Position';
    const posLMR = ()=> 'Position';
    const seenPosOptions = ()=> [ 'Position', 'Gewohnheit', 'Aus Gefühl', 'Sonstiges' ];
    const blobDownload = (filename, text) => { const url = URL.createObjectURL(new Blob([text])); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); };
    let _attrCleanup = null;
    function dismissAttribution(){
      const root = document.getElementById('attr');
      if(!root) return;
      root.classList.add('hidden');
      const reopen = document.getElementById('attr-reopen');
      if(reopen) reopen.classList.remove('hidden');
      if(typeof _attrCleanup === 'function'){
        try { _attrCleanup(); } catch {}
        _attrCleanup = null;
      }
    }

    // ===== Global State =====
    const CONDITION = 'persuasive';
    const COLLECT_URL = window.COLLECT_URL || '';
    // Client/Device metadata for analysis (mobile vs desktop etc.)
    const CLIENT = (()=>{
      const ua = navigator.userAgent || '';
      const isTouch = (('ontouchstart' in window) || (navigator.maxTouchPoints||0) > 0);
      const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(ua) || (window.matchMedia && window.matchMedia('(pointer:coarse)').matches) || (window.innerWidth < 640);
      const dpr = Number(window.devicePixelRatio||1);
      const vp = { w: window.innerWidth||0, h: window.innerHeight||0 };
      let orientation = 'unknown';
      try { orientation = (vp.h>=vp.w) ? 'portrait' : 'landscape'; } catch {}
      return { ua, isTouch, isMobile, dpr, viewport: vp, orientation };
    })();
    const state = {
      startedAt: null,
      events: [],
      step: 'intro',
      consent: false,
     exp1: {
  name:'proximity_grouping',
  // pro Session genau eine Variante: "grouping_A" ODER "cta_C"
  variant: Math.random() < 0.5 ? 'grouping_A' : 'cta_C',
  startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{}
},
      exp2: { name:'cta_shape', variant: Math.random()<0.5?'round_high':'square_low', leftSalient: Math.random()<0.5, startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
      exp3: { name:'social_proof', variant:'present', startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
      exp4: { name:'shipping_defaults', variant: ['default_fast','default_standard','default_green'][Math.floor(Math.random()*3)], startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
      exp5: { name:'left_bias_equal', startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
      exp4pref:{ name:'shipping_preference', startedAt:null, finishedAt:null, clicks:0, selected:null, extra:{} },
      exp2b:{ name:'cta_color', blackLeft: Math.random()<0.5, startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
      exp6: { name:'single_button', posTop: Math.random()<0.5, startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
      exp6chk: { name:'confirm_distance', variant: Math.random()<0.5?'near':'far', startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
      exp8: { name:'cta_signifier', variant: Math.random()<0.5?'with_icon':'no_icon', startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
      exp10icon: { name:'cta_signifier_2', iconLeft: Math.random()<0.5, startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
       exp11gc: { name:'good_continuation', variant: Math.random()<0.5?'linear':'scatter', startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
       exp12fg: { name:'figure_ground', variant: 'one_emph', startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
       exp12sd: { name:'similarity_dissimilarity', variant: ['soft_emph','strong_emph'][Math.floor(Math.random()*2)], emphPos: ['left','middle','right'][Math.floor(Math.random()*3)], startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
       exp14sp: { name:'social_proof_strong', startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
       exp15left: { name:'left_bias_equal_cards', startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
       exp7: { name:'order_alignment', variant: Math.random()<0.5?'left_target':'right_target', startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
      
      
      exp13:{ name:'cta_icon', variant: Math.random()<0.5?'generic':'actionable', startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} },
      survey: { ease:null, intrusiveness:null, trust:null, satisfaction:null, autonomy:null, effort:null, frustration:null, helpfulPersuasion:null, noticedSocialProof:null, noticedDefault:null, noticedGrouping:null, noticedScarcity:null, noticedOrder:null, noticedFeedbackLatency:null, noticedPD:null, noticedChoiceOverload:null, noticedCardEmphasis:null, noticedCtaIcon:null, openComment:'' },
    };

    function go(step){
  // interner Zustand
  state.step = step;
  try { dismissAttribution(); } catch {}

  // --- virtuelle URL konstant halten (keine ?screen-Query) ---
  try {
    const constantUrl = window.location.origin + window.location.pathname; // z. B. '/survey' oder aktuelle Seite
    history.replaceState({ screen: step }, '', constantUrl);
  } catch {}

  // --- Microsoft Clarity annotieren (optional, safe) ---
  if (window.clarity) {
    try {
      window.clarity('set', 'screen', step);
      window.clarity('event', 'screen_change_' + step);
    } catch {}
  }

  // Back-Button Sichtbarkeit steuern
  try {
    const backBtn = document.getElementById('btn-back');
    if(backBtn){ backBtn.classList.toggle('hidden', screens.indexOf(step) <= 0); }
    // Auf Survey/Debrief keine Back- oder Reopen-Buttons anzeigen
    if(step==='survey' || step==='debrief'){
      if(backBtn){ backBtn.classList.add('hidden'); }
      try { const ro = document.getElementById('attr-reopen'); if(ro) ro.classList.add('hidden'); } catch {}
    }
    const sel = document.getElementById('jump-select');
    if(sel){ sel.value = step; }
  } catch {}

  // --- ab hier DEIN bestehender, funktionierender Teil unverndert ---
  progress(screens.indexOf(step));
  screens.forEach(id => $('#screen-'+id).classList.toggle('hidden', id!==step));

  if(step==='exp1' && !state.exp1.startedAt){ state.exp1.startedAt = now(); renderExp1(); }
  if(step==='exp2' && !state.exp2.startedAt){ state.exp2.startedAt = now(); renderExp2(); }
  if(step==='exp3' && !state.exp3.startedAt){ state.exp3.startedAt = now(); renderExp3(); }
  if(step==='exp4' && !state.exp4.startedAt){ state.exp4.startedAt = now(); renderExp4(); }
  if(step==='exp4pref' && !state.exp4pref.startedAt){ state.exp4pref.startedAt = now(); renderExp4pref(); }
  if(step==='exp5' && !state.exp5.startedAt){ state.exp5.startedAt = now(); renderExp5(); }
  if(step==='exp2b'&& !state.exp2b.startedAt){ state.exp2b.startedAt = now(); renderExp2b(); }
  if(step==='exp6' && !state.exp6.startedAt){ state.exp6.startedAt = now(); renderExp6(); }
  if(step==='exp7' && !state.exp7.startedAt){ state.exp7.startedAt = now(); renderExp7(); }
  if(step==='exp8' && !state.exp8.startedAt){ state.exp8.startedAt = now(); renderExp8(); }
  if(step==='exp9b'&& !state.exp9b?.startedAt){ state.exp9b = state.exp9b || { name:'social_proof_v2', variant:'subtitle_note', startedAt:null, finishedAt:null, clicks:0, errors:0, success:false, ttf:null, extra:{} }; state.exp9b.startedAt = now(); renderExp9b(); }
  if(step==='exp10icon' && !state.exp10icon.startedAt){ state.exp10icon.startedAt = now(); renderExp10icon(); }
  if(step==='exp11gc' && !state.exp11gc.startedAt){ state.exp11gc.startedAt = now(); renderExp11gc(); }
  if(step==='exp12sd' && !state.exp12sd.startedAt){ state.exp12sd.startedAt = now(); renderExp12sd(); }
  if(step==='exp14sp' && !state.exp14sp.startedAt){ state.exp14sp.startedAt = now(); renderExp14sp(); }
  if(step==='exp15left' && !state.exp15left.startedAt){ state.exp15left.startedAt = now(); renderExp15left(); }
  if(step==='exp6chk' && !state.exp6chk.startedAt){ state.exp6chk.startedAt = now(); renderExp6chk(); }
  if(step==='exp12fg' && !state.exp12fg.startedAt){ state.exp12fg.startedAt = now(); renderExp12fg(); }
  if(step==='survey'){ renderSurvey(); }
}


    function ttfSet(task){ if(task.ttf==null) task.ttf = Math.round(now() - task.startedAt); }
    function log(type, data){ state.events.push({ t: state.startedAt? Math.round(now()-state.startedAt):0, type, data }); }

    // ===== Intro =====
    $('#consent').addEventListener('change', (e)=>{
      state.consent = e.target.checked;
      const b = $('#btn-start');
      if(state.consent){ b.disabled=false; b.className='btn btn-primary'; }
      else { b.disabled=true; b.className='btn btn-disabled'; }
    });
    $('#btn-start').addEventListener('click', ()=>{ if(!state.consent) return; state.startedAt = now(); log('session_start',{ condition:CONDITION }); go('exp1'); });

    // Quick jump control (for faster testing)
    (function setupJump(){
      try {
        const sel = document.getElementById('jump-select');
        const btn = document.getElementById('jump-go');
        if(!sel || !btn) return;
        sel.innerHTML = screens.map(id=>`<option value="${id}">${id}</option>`).join('');
        sel.value = 'intro';
        btn.addEventListener('click', ()=>{ const v = sel.value; if(v) go(v); });
      } catch {}
    })();

    // ===== EXP 1: Proximity/Grouping =====
    let exp1Cards = [
      { id:'starter', title:'Starter', price:'9,99 € / Monat', desc:'Basis-Tools: Aufgaben & Notizen' },
      { id:'plus',    title:'Plus',    price:'9,99 € / Monat', desc:'Organisation: Kalender & Erinnerungen' },
      { id:'pro',     title:'Pro',     price:'9,99 € / Monat', desc:'Teamwork: Freigaben & Rollen' },
    ];
    // Unify offers (same price/features) and neutral labels
    exp1Cards = exp1Cards.map((c,i)=>({
      ...c,
      id: ['a','b','c'][i],
      title: `Paket ${['A','B','C'][i]}`,
      price: '9,99 € / Monat',
      desc: 'Tools: Aufgaben, Notizen, Kalender, Freigaben'
    }));
    const exp1TargetId = ['a','b','c'][Math.floor(Math.random()*3)];
    function renderExp1(){
      const wrap = $('#exp1-cards'); wrap.innerHTML='';
      exp1Cards.forEach(c=>{
        const isTarget = c.id===exp1TargetId;
        const card = document.createElement('div');
        card.className = 'card soft flex-col';
        card.innerHTML = `
          <div class="row between">
            <div class="plan__title">${c.title}</div>
            <div class="plan__price">${c.price}</div>
          </div>
          <div class="plan__desc">${c.desc}</div>
          <div class="mt">
            ${isTarget ? `
              <div class="group-box">
                <ul class="list small mb">
                  <li>Unbegrenzte Projekte</li>
                  <li>Grundlegende Analyse</li>
                  <li>Support per E-Mail</li>
                </ul>
                <button type="button" class="btn btn-outline btn-block exp1-choose">Wählen</button>
              </div>
            ` : `
              <ul class="list small mt">
                <li>Unbegrenzte Projekte</li>
                <li>Grundlegende Analyse</li>
                <li>Support per E-Mail</li>
              </ul>
              <div class="divider"></div>
              <button type="button" class="btn btn-outline btn-block exp1-choose">Wählen</button>
            `}
          </div>`;
        card.querySelectorAll('.exp1-choose').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            ttfSet(state.exp1); state.exp1.clicks++; state.exp1.success=true; state.exp1.finishedAt=now();
            state.exp1.extra = { clickedCard:c.id, targetId:exp1TargetId, isTarget };
            openAttribution({
              title:'Kurze Einordnung - Schritt 1',
              options:['Nähe des Buttons','Gruppierung','Abstand','Position','Sonstiges'],
              onDone:(reason)=>{ state.exp1.extra.reason=reason; go('exp2'); }
            });
          });
        });
        
        wrap.appendChild(card);
      });
    }

    // ===== EXP 2: Buttonform/Kontrast =====
    function renderExp2(){
      const variant = state.exp2.variant; // 'round_high' oder 'square_low'
      const leftSalient = state.exp2.leftSalient;
      const leftStyle = (leftSalient ? variant : (variant==='round_high'?'square_low':'round_high'));
      const rightStyle = (!leftSalient ? variant : (variant==='round_high'?'square_low':'round_high'));
      // Single-Faktor: Nur die Form variiert, Farbe/Kontrast identisch
      const styleToClass = (s)=> s==='round_high' ? 'btn btn-primary btn-pill' : 'btn btn-primary btn-square';
      const leftBtn = $('#exp2-left'); const rightBtn = $('#exp2-right');
      leftBtn.className = styleToClass(leftStyle);
      rightBtn.className = styleToClass(rightStyle);
      const handler = (pos)=>{
        if(state.exp2.ttf==null) state.exp2.ttf = Math.round(now()-state.exp2.startedAt);
        state.exp2.clicks++;
        const clickedStyle = pos==='left'? leftStyle : rightStyle;
        const success = clickedStyle===variant; if(!success) state.exp2.errors++;
        state.exp2.success = success; state.exp2.finishedAt = now();
        state.exp2.extra = { clicked:clickedStyle, expected:variant, clickedPos:pos, salientPos:leftSalient?'left':'right' };
        openAttribution({
          title:'Kurze Einordnung – Schritt 2',
          options:['Buttonform (rund/eckig)','Kontrast/Farbe','Position','Gewohnheit','Sonstiges'],
          onDone:(reason)=>{ state.exp2.extra.reason=reason; go('exp3'); }
        });
      };
      leftBtn.onclick = ()=>handler('left');
      rightBtn.onclick = ()=>handler('right');
    }

    // ===== EXP 3: Social Proof =====
    let products = [
      { id:'basic', name:'Basic Bottle', subtitle:'Einfach, robust', price:12.99, rating:3.9, shipping:'2–3 Tage' },
      { id:'reuse', name:'ReUse+ Bottle', subtitle:'Nachhaltig, wiederverwendbar', price:18.90, rating:4.6, shipping:'1–2 Tage', eco:true },
      { id:'steel', name:'Steel Bottle', subtitle:'Doppelwand-Edelstahl', price:24.00, rating:4.4, shipping:'2–4 Tage' },
    ];
    // Unify product offer details and names for fairness
    products = products.map(p=>({ ...p, name:'Trinkflasche', subtitle:'Leicht, robust', price:19.90, rating:4.4, shipping:'2-3 Tage', eco:false }));
    const exp3TargetId = ['reuse','basic','steel'][Math.floor(Math.random()*3)];
    const exp3BannerCount = [198,210,224,231][Math.floor(Math.random()*4)];
    function renderExp3(){
      // Hinweis in der Karte statt separatem Banner; ohne farbliche Hervorhebung
      try { const b = document.getElementById('exp3-banner'); if(b){ b.innerHTML=''; b.classList.add('hidden'); } } catch {}
      const grid = $('#exp3-grid'); grid.innerHTML='';
      const order = [0,1,2].sort(()=>Math.random()-0.5);
      order.forEach(idx=>{
        const p = products[idx]; const isTarget = p.id===exp3TargetId;
        const card = document.createElement('div');
        // Keine Hervorhebung der Zielkarte
        card.className = 'card soft';
        const popularNote = isTarget ? `<div class="muted small">Beliebt heute, ${exp3BannerCount} mal gekauft:</div>` : '';
        card.innerHTML = `
          <div class="muted small">${p.subtitle}</div>
          <div class="thumb"></div>
          <div class="item__name">${p.name} ${p.eco?'':''}</div>
          ${popularNote}
          <div class="muted small">${p.price.toFixed(2)}€  ${p.rating.toFixed(1)}★  Versand: ${p.shipping}</div>
          <button type="button" class="btn mt">In den Warenkorb</button>`;
        /*
        // Normalisierung zur Reduktion von Störfaktoren (keine Hervorhebung/Farbunterschiede)
        try {
          card.className = 'card soft';
          const thumb = card.querySelector('.thumb'); if(thumb){ thumb.className = 'thumb'; }
          const nameEl = card.querySelector('.item__name'); if(nameEl){ nameEl.textContent = p.name; }
          const infoEls = card.querySelectorAll('.muted.small');
          if(infoEls[0]) infoEls[0].textContent = 'Leicht, robust';
          if(infoEls[1]) infoEls[1].textContent = `€ ${(19.90).toFixed(2)}  ${(4.4).toFixed(1)}★  Versand: 2–3 Tage`;
          const btnEl = card.querySelector('button'); if(btnEl){ btnEl.className = 'btn mt'; }
        } catch {} */
        card.querySelector('button').addEventListener('click', ()=>{
          ttfSet(state.exp3); state.exp3.clicks++; state.exp3.success=true; state.exp3.finishedAt=now();
          state.exp3.extra = { bannerChoices: isTarget?1:0, otherChoices: isTarget?0:1, targetName: products.find(pp=>pp.id===exp3TargetId).name, bannerCount: exp3BannerCount };
          openAttribution({
            title:'Kurze Einordnung – Schritt 3',
            options:['Beliebtheitshinweis','Hervorhebung/Ring','Nachhaltigkeit','Sonstiges'],
            onDone:(reason)=>{ state.exp3.extra.reason=reason; go('exp4'); }
          });
        });
        grid.appendChild(card);
      });
    }

    // ===== EXP 4: Shipping Defaults =====
    function renderExp4(){
      const opts = [
        { id:'fast', label:'Schneller Versand (1–2 Tage) +3,00 € ' },
        { id:'standard', label:'Standard (2–3 Tage) 0,00 € ' },
        { id:'green', label:'Klimafreundlich (2–4 Tage) +0,50 € ' },
      ];
      const wrap = $('#exp4-options'); wrap.innerHTML='';
      opts.forEach(opt=>{
        const lab = document.createElement('label'); lab.className='radio-row';
        const inp = document.createElement('input'); inp.type='radio'; inp.name='ship'; inp.value = opt.id;
        if((state.exp4.variant==='default_fast'&&opt.id==='fast')||(state.exp4.variant==='default_standard'&&opt.id==='standard')||(state.exp4.variant==='default_green'&&opt.id==='green')) inp.checked=true;
        inp.addEventListener('change', ()=>{
          if(state.exp4.ttf==null) state.exp4.ttf = Math.round(now()-state.exp4.startedAt);
          state.exp4.clicks++; state.exp4.extra.selectedOption = opt.id; state.exp4.extra.defaultOption = state.exp4.variant.replace('default_','');
        });
        const span = document.createElement('span'); span.textContent = opt.label;
        lab.appendChild(inp); lab.appendChild(span);
        wrap.appendChild(lab);
      });
      $('#exp4-save').onclick = ()=>{
        const selected = (state.exp4.extra && state.exp4.extra.selectedOption) || state.exp4.variant.replace('default_','');
        state.exp4.success = true; state.exp4.finishedAt = now();
        state.exp4.extra.selectedOption = selected; state.exp4.extra.defaultOption = state.exp4.variant.replace('default_','');
        state.exp4.extra.adopted = selected === state.exp4.variant.replace('default_','');
        openAttribution({
          title:'Kurze Einordnung - Schritt 4',
          options:['Voreinstellung','Lieferzeit','Kosten','Nachhaltigkeit','Sonstiges'],
          onDone:(reason)=>{ state.exp4.extra.reason=reason; go('exp4pref'); }
        });
      };
    }

    // ===== EXP 4 Preference: Bevorzugte Versandart =====
    function renderExp4pref(){
      const opts = [
        { id:'fast', label:'Schneller Versand (1-2 Tage) – leichter Aufpreis' },
        { id:'standard', label:'Standard (2-3 Tage) – kein Aufpreis' },
        { id:'green', label:'Klimafreundlich (2-4 Tage) – leichter Aufpreis' },
      ];
      const wrap = document.getElementById('exp4pref-options');
      if(!wrap) { go('exp5'); return; }
      wrap.innerHTML = '';
      let selected = state.exp4pref.selected || null;
      opts.forEach(opt=>{
        const lab = document.createElement('label'); lab.className='radio-row';
        const inp = document.createElement('input'); inp.type='radio'; inp.name='ship_pref'; inp.value=opt.id; inp.checked = (selected===opt.id);
        inp.addEventListener('change', (e)=>{ selected = e.target.value; state.exp4pref.clicks++; try{ const nx=document.getElementById('exp4pref-next'); if(nx){ nx.disabled=false; nx.classList.remove('btn-disabled'); nx.classList.add('btn-primary'); } }catch{} });
        const span = document.createElement('span'); span.textContent = opt.label;
        lab.appendChild(inp); lab.appendChild(span);
        wrap.appendChild(lab);
      });
      const nextBtn = document.getElementById('exp4pref-next');
      if(nextBtn){
        // initially disabled until choice made
        nextBtn.disabled = !selected; nextBtn.classList.toggle('btn-disabled', !selected); nextBtn.classList.toggle('btn-primary', !!selected);
        nextBtn.onclick = ()=>{
          if(!selected){ return; }
          if(state.exp4pref.startedAt && !state.exp4pref.finishedAt){ state.exp4pref.finishedAt = now(); }
          state.exp4pref.selected = selected;
          go('exp5');
        };
      }
    }

    // ===== EXP 5: Left Bias mit gleichen Karten =====
    function renderExp5(){
      const grid = document.getElementById('exp5-grid'); if(!grid){ return; }
      grid.innerHTML='';
      const cards = ['A','B','C'].map((lab,i)=>({ id:['left','middle','right'][i], title:`Paket ${lab}`, price:'9,99 € / Monat', desc:'Tools: Aufgaben, Notizen, Kalender, Freigaben' }));
      cards.forEach(c=>{
        const el = document.createElement('div');
        el.className = 'card soft';
        el.innerHTML = `
          <div class="row between">
            <div class="plan__title">${c.title}</div>
            <div class="plan__price">${c.price}</div>
          </div>
          <div class="plan__desc">${c.desc}</div>
          <ul class="list small mt">
            <li>Unbegrenzte Projekte</li>
            <li>Grundlegende Analyse</li>
            <li>Support per E-Mail</li>
          </ul>
          <div class="divider" style="margin-top:12px;"></div>
          <button type="button" class="btn-big-outline exp5-choose">Wählen</button>`;
        el.querySelector('.exp5-choose').addEventListener('click', ()=>{
          if(state.exp5.ttf==null) state.exp5.ttf = Math.round(now()-state.exp5.startedAt);
          state.exp5.clicks++; state.exp5.success=true; state.exp5.finishedAt=now();
          state.exp5.extra = { clickedPos: c.id };
          openAttribution({
            title:'Kurze Einordnung - Schritt 5',
            options:['Position (links/mitte/rechts)','Gefühl','Gewohnheit','Sonstiges'],
            onDone:(reason)=>{ state.exp5.extra.reason=reason; go('exp2b'); }
          });
        });
        grid.appendChild(el);
      });
    }

    // ===== Survey =====
    function likertMount(containerId, id, label){
      const root = document.createElement('div'); root.className='likert';
      root.innerHTML = `<div class="likert__label">${label}</div>
      <div class="likert__scale">${[1,2,3,4,5,6,7,8,9,10].map(n=>`<label class="likert__dot"><input type="radio" name="${id}" value="${n}" class="sr"><span>${n}</span></label>`).join('')}</div>`;
      // State-Update bei Change
      root.querySelectorAll(`input[name="${id}"]`).forEach(inp=>{
        inp.addEventListener('change', (e)=>{ state.survey[id] = Number(e.target.value); });
      });
      // Fallback: Klick auf Label erzwingt Auswahl + Change
      root.querySelectorAll('.likert__dot').forEach(lbl=>{
        lbl.addEventListener('click', ()=>{
          const input = lbl.querySelector('input');
          if (!input.checked) {
            input.checked = true;
            input.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });
      });
      const note = document.createElement('input'); note.type='text'; note.className='input mt'; note.placeholder='Zusätzliches Feedback'; try { note.value = state.survey[id+'_note'] || ''; } catch {} note.addEventListener('input', (e)=>{ try { state.survey[id+'_note'] = e.target.value; } catch {} }); root.appendChild(note); document.getElementById(containerId).appendChild(root);
    }
    function renderSurvey(){
      const input = document.getElementById('openComment');
      if(input){
        try { input.value = state.survey.openComment || ''; } catch {}
        input.oninput = (e)=>{ state.survey.openComment = e.target.value; };
      }
      const finishBtn = document.getElementById('survey-finish');
      if(finishBtn){ finishBtn.onclick = ()=>{ go('debrief'); }; }
    }

    
    // ===== EXP 2b: CTA Farbe (rund vs. rund, schwarz vs. weiß) =====
    function renderExp2b(){
      const blackLeft = !!state.exp2b.blackLeft;
      const left = document.getElementById('exp2b-left');
      const right = document.getElementById('exp2b-right');
      if(!left || !right){ go('exp6'); return; }
      // Beide rund, nur Farbe unterschiedlich
      left.className = 'btn btn-pill ' + (blackLeft ? 'btn-primary' : 'btn-outline');
      right.className = 'btn btn-pill ' + (!blackLeft ? 'btn-primary' : 'btn-outline');
      const handler = (pos)=>{
        if(state.exp2b.ttf==null) state.exp2b.ttf = Math.round(now()-state.exp2b.startedAt);
        state.exp2b.clicks++;
        state.exp2b.success = true; state.exp2b.finishedAt = now();
        state.exp2b.extra = { clickedPos: pos, blackLeft };
        openAttribution({
          title:'Kurze Einordnung - Zusatztest',
          options:['Farbe/Kontrast','Position','Gewohnheit','Sonstiges'],
          onDone:(reason)=>{ state.exp2b.extra.reason=reason; go('exp6'); }
        });
      };
      left.onclick = ()=>handler('left');
      right.onclick = ()=>handler('right');
    }
// ===== Attribution Overlay =====
    function openAttribution({title, options, onDone}){
      const root = document.getElementById('attr');
      const modal = root.querySelector('.modal');
      const closeBtn = document.getElementById('attr-close');
      const reopenBtn = document.getElementById('attr-reopen');

      // clean previous handlers if any
      if(typeof _attrCleanup === 'function'){ try { _attrCleanup(); } catch {} }

      // build options as checklist (Mehrfachauswahl)
      const box = document.getElementById('attr-options'); box.innerHTML='';
      document.getElementById('attr-title').textContent = title;
      const selected = new Set();
      const list = document.createElement('div');
      list.className = 'stack gap-sm';
      options.forEach(opt=>{
        const row = document.createElement('label');
        row.className = 'checkbox-row';
        const inp = document.createElement('input'); inp.type='checkbox'; inp.value=opt;
        inp.addEventListener('change', (e)=>{ if(e.target.checked){ selected.add(opt); } else { selected.delete(opt); } });
        const span = document.createElement('span'); span.textContent = opt;
        row.appendChild(inp); row.appendChild(span); list.appendChild(row);
      });
      box.appendChild(list);

      // helper to fully finish and cleanup
      const finish = (reason)=>{
        root.classList.add('hidden');
        if(reopenBtn) reopenBtn.classList.add('hidden');
        document.getElementById('attr-note').value='';
        try { if(typeof _attrCleanup === 'function') _attrCleanup(); } catch {}
        _attrCleanup = null;
        onDone(reason);
      };

      // save/skip act as forward
      document.getElementById('attr-save').onclick = ()=>{
        const note = (document.getElementById('attr-note').value||'').trim();
        const reason = Array.from(selected).join('|') + (note? (selected.size? ' :: ':'') + note : '');
        finish(reason);
      };
      document.getElementById('attr-skip').onclick = ()=>{ finish(''); };

      // Close behavior (just hide, do NOT call onDone)
      const hideOnly = ()=>{
        root.classList.add('hidden');
        if(reopenBtn) reopenBtn.classList.remove('hidden');
      };
      if(closeBtn) closeBtn.onclick = hideOnly;
      // click outside modal closes
      const onOverlayClick = (e)=>{ if(e.target === root) hideOnly(); };
      root.addEventListener('click', onOverlayClick);
      // ESC closes
      const onKey = (e)=>{ if(e.key === 'Escape'){ hideOnly(); } };
      document.addEventListener('keydown', onKey);

      // draggable: drag by visible handle
      let dragging = false; let sx=0, sy=0, sl=0, st=0;
      const titleEl = document.getElementById('attr-title');
      const dragEl = document.getElementById('attr-drag') || titleEl;
      const onDown = (e)=>{
        dragging = true;
        const rect = modal.getBoundingClientRect();
        // switch to fixed positioning at current spot
        modal.style.position = 'fixed';
        modal.style.left = rect.left + 'px';
        modal.style.top = rect.top + 'px';
        modal.style.transform = 'none';
        sx = (e.touches? e.touches[0].clientX : e.clientX);
        sy = (e.touches? e.touches[0].clientY : e.clientY);
        sl = rect.left; st = rect.top;
        document.body.style.userSelect = 'none';
        modal.classList.add('modal--dragging');
      };
      const onMove = (e)=>{
        if(!dragging) return;
        const cx = (e.touches? e.touches[0].clientX : e.clientX);
        const cy = (e.touches? e.touches[0].clientY : e.clientY);
        const nl = sl + (cx - sx);
        const nt = st + (cy - sy);
        modal.style.left = nl + 'px';
        modal.style.top = nt + 'px';
      };
      const onUp = ()=>{ dragging = false; document.body.style.userSelect=''; modal.classList.remove('modal--dragging'); };
      if(dragEl){
        dragEl.addEventListener('mousedown', onDown);
        dragEl.addEventListener('touchstart', onDown, {passive:true});
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('touchmove', onMove, {passive:true});
      document.addEventListener('mouseup', onUp);
      document.addEventListener('touchend', onUp);

      // expose cleanup for dismissAttribution/back navigation
      _attrCleanup = ()=>{
        try { root.removeEventListener('click', onOverlayClick); } catch {}
        try { document.removeEventListener('keydown', onKey); } catch {}
        try { document.removeEventListener('mousemove', onMove); } catch {}
        try { document.removeEventListener('touchmove', onMove); } catch {}
        try { document.removeEventListener('mouseup', onUp); } catch {}
        try { document.removeEventListener('touchend', onUp); } catch {}
        if(dragEl){
          try { dragEl.removeEventListener('mousedown', onDown); } catch {}
          try { dragEl.removeEventListener('touchstart', onDown); } catch {}
        }
      };

      // allow reopening when previously closed
      if(reopenBtn){
        reopenBtn.onclick = ()=>{ root.classList.remove('hidden'); reopenBtn.classList.add('hidden'); };
      }

      // show modal and hide reopen button while active
      if(reopenBtn) reopenBtn.classList.add('hidden');
      root.classList.remove('hidden');
    }

    // ===== EXP 6: Fitts's Law =====
    function renderExp6(){
      const btn = document.getElementById('exp6-cta');
      if(!btn){ go('exp7'); return; }
      const wrap = document.getElementById('exp6-wrap');
      try {
        // place button high or low to affect time to click
        const top = state.exp6.posTop === true;
        wrap.style.minHeight = '360px';
        wrap.style.justifyContent = 'flex-start';
        // row is the parent of the button
        const row = btn.parentElement;
        const offset = top ? 24 : 280; // px from top
        row.style.marginTop = offset + 'px';
        state.exp6.extra = { offsetPx: offset, pos: top ? 'top' : 'bottom' };
      } catch {}
      btn.onclick = ()=>{
        if(state.exp6.ttf==null) state.exp6.ttf = Math.round(now()-state.exp6.startedAt);
        state.exp6.clicks++; state.exp6.success=true; state.exp6.finishedAt=now();
        go('exp6chk');
      };
    }

    // ===== EXP 6b: Confirm + Distance =====
    function renderExp6chk(){
      const cb = document.getElementById('exp6chk-cb');
      const btn = document.getElementById('exp6chk-next');
      const wrap = document.getElementById('exp6chk-wrap');
      if(!cb || !btn || !wrap){ go('exp7'); return; }

      const far = state.exp6chk.variant === 'far';
      const gap = far ? 160 : 12; // px distance between checkbox and button
      try { btn.parentElement.style.marginTop = gap + 'px'; } catch {}
      state.exp6chk.extra = { gapPx: gap, variant: far ? 'far' : 'near' };

      const update = ()=>{
        const enabled = !!cb.checked;
        btn.disabled = !enabled;
        btn.classList.toggle('btn-disabled', !enabled);
      };
      update();
      cb.addEventListener('change', update);

      btn.onclick = ()=>{
        if(btn.disabled) return;
        if(state.exp6chk.ttf==null) state.exp6chk.ttf = Math.round(now()-state.exp6chk.startedAt);
        state.exp6chk.clicks++; state.exp6chk.success=true; state.exp6chk.finishedAt=now();
        go('exp7');
      };
    }

    // ===== EXP 8: CTA-Signifier =====
    function renderExp8(){
      const btn = document.getElementById('exp8-cta');
      if(!btn){ go('survey'); return; }
      const v = state.exp8.variant; // 'with_icon' | 'no_icon'
      btn.innerHTML = v==='with_icon'
        ? 'Weiter <span aria-hidden="true" style="margin-left:6px">➔</span>'
        : 'Weiter';
      btn.onclick = ()=>{
        if(state.exp8.ttf==null) state.exp8.ttf = Math.round(now()-state.exp8.startedAt);
        state.exp8.clicks++; state.exp8.success=true; state.exp8.finishedAt=now();
        state.exp8.extra = { variant: v };
        openAttribution({
          title:'Einordnung - Schritt 8',
          options:['Pfeil/Zeichen','Position','Gewohnheit','Sonstiges'],
          onDone:(reason)=>{ state.exp8.extra.reason = reason; go('exp9b'); }
        });
      };
    }

    // ===== EXP 9b: Social Proof v2 (Label oben) =====
    const exp9bTargetId = ['reuse','basic','steel'][Math.floor(Math.random()*3)];
    const exp9bBannerCount = [198,210,224,231][Math.floor(Math.random()*4)];
    function renderExp9b(){
      const grid = document.getElementById('exp9b-grid'); if(!grid){ go('survey'); return; }
      grid.innerHTML='';
      const order = [0,1,2].sort(()=>Math.random()-0.5);
      order.forEach(idx=>{
        const p = products[idx];
        const isTarget = p.id===exp9bTargetId;
        const card = document.createElement('div');
        card.className = 'card soft';
      const topLine = `<div class="muted small">${p.subtitle} ${isTarget? `<span class=\"badge-note\" title=\"Viele Käufe heute\" aria-label=\"Beliebt heute:\">Beliebt heute: · ${exp9bBannerCount}×</span>` : ''}</div>`;
        const topNote = isTarget ? `<div class="muted small">Beliebt heute: ${exp9bBannerCount} mal gekauft</div>` : '';
        const subLine = `<div class="muted small">${p.subtitle}</div>`;
        card.innerHTML = `
          ${topNote}${subLine}
          <div class="thumb"></div>
          <div class="item__name">${p.name}</div>
          <div class="muted small">${p.price.toFixed(2)}&nbsp;&euro;&nbsp;&nbsp;${p.rating.toFixed(1)}&#9733;&nbsp;&nbsp;Versand: ${p.shipping}</div>
          <button type="button" class="btn mt">In den Warenkorb</button>`;
        card.querySelector('button').addEventListener('click', ()=>{
          if(state.exp9b.ttf==null) state.exp9b.ttf = Math.round(now()-state.exp9b.startedAt);
          state.exp9b.clicks++; state.exp9b.success=true; state.exp9b.finishedAt=now();
          state.exp9b.extra = { bannerChoices: isTarget?1:0, otherChoices: isTarget?0:1, targetName: products.find(pp=>pp.id===exp9bTargetId).name, bannerCount: exp9bBannerCount };
          openAttribution({
            title:'Einordnung - Schritt 8',
            options:['Beliebtheitshinweis','Sonstiges'],
            onDone:(reason)=>{ state.exp9b.extra.reason=reason; go('exp10icon'); }
          });
        });
        grid.appendChild(card);
      });
    }

    // ===== EXP 10: CTA-Signifier (with icon vs. no icon) =====
    function renderExp10icon(){
      const left = document.getElementById('exp10icon-left');
      const right = document.getElementById('exp10icon-right');
      if(!left || !right){ go('survey'); return; }
      const iconLeft = !!state.exp10icon.iconLeft;
      const withIcon = (el)=>{ el.innerHTML = 'Weiter <span aria-hidden="true" style="margin-left:6px">&#10140;</span>'; };
      const noIcon = (el)=>{ el.textContent = 'Weiter'; };
      if(iconLeft){ withIcon(left); noIcon(right); } else { noIcon(left); withIcon(right); }
      const handler = (pos)=>{
        if(state.exp10icon.ttf==null) state.exp10icon.ttf = Math.round(now()-state.exp10icon.startedAt);
        state.exp10icon.clicks++; state.exp10icon.success=true; state.exp10icon.finishedAt=now();
        state.exp10icon.extra = { iconPos: iconLeft?'left':'right', clickedPos: pos };
        openAttribution({
          title:'Einordnung - Schritt 9',
          options:['Icon/Zeichen','Nur Text','Position','Gewohnheit','Sonstiges'],
          onDone:(reason)=>{ state.exp10icon.extra.reason = reason; go('exp11gc'); }
        });
      };
      left.onclick = ()=>handler('left');
      right.onclick = ()=>handler('right');
    }

    // ===== EXP 11: Good Continuation =====
    function renderExp11gc(){
      const wrap = document.getElementById('exp11gc-wrap');
      if(!wrap){ go('survey'); return; }
      wrap.innerHTML = '';
      const variant = state.exp11gc.variant; // 'linear' | 'scatter'

      const nums = [1,2,3,4,5,6,7,8,9];
      const target = 9;

      if(variant === 'linear'){
        const row = document.createElement('div');
        row.className = 'gc-seq';
        nums.forEach(n=>{ const b=document.createElement('button'); b.className='btn btn-chip'; b.textContent=String(n); b.dataset.n=String(n); row.appendChild(b); });
        wrap.appendChild(row);
      } else {
        // Scatter: sichere Ränder + genügend Innenhöhe, vermeidet Überlappung und Anschnitt am Rand
        const PAD = 28;           // Randabstand in px
        const BTN = 48;           // angenommener Button-Durchmesser (Chip)
        const H   = 260;          // Innenhöhe
        wrap.style.minHeight = H + 'px';
        wrap.style.position   = 'relative';
        const placed = [];
        function overlaps(x,y){ return placed.some(p=> Math.hypot(p.x-x, p.y-y) < (BTN+8)); }
        const W = wrap.clientWidth || 320;
        nums.forEach(n=>{
          const b=document.createElement('button'); b.className='btn btn-chip'; b.textContent=String(n); b.dataset.n=String(n);
          b.style.position='absolute';
          let x,y,tries=0; do {
            x = PAD + Math.random() * Math.max(1, (W - 2*PAD - BTN));
            y = PAD + Math.random() * Math.max(1, (H - 2*PAD - BTN));
            tries++;
          } while(overlaps(x,y) && tries<80);
          placed.push({x,y}); b.style.left = x+'px'; b.style.top = y+'px'; wrap.appendChild(b);
        });
      }

      const buttons = wrap.querySelectorAll('button.btn');
      buttons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          if(state.exp11gc.ttf==null) state.exp11gc.ttf = Math.round(now()-state.exp11gc.startedAt);
          state.exp11gc.clicks++;
          const n = Number(btn.dataset.n||'0');
          if(n !== target){ state.exp11gc.errors = (state.exp11gc.errors||0)+1; }
          state.exp11gc.success=true; state.exp11gc.finishedAt=now();
          state.exp11gc.extra = { variant, target, clicked: n };
          openAttribution({
            title:'Einordnung - Schritt 11',
            options:['Lineare Anordnung','Zufällige Position','Gewohnheit','Sonstiges'],
            onDone:(reason)=>{ state.exp11gc.extra.reason = reason; go('exp12fg'); }
          });
        });
      });
    }

    // ===== EXP 12: Figure–Ground (subtile Hervorhebung) =====
    function renderExp12fg(){
      const wrap = document.getElementById('exp12fg-cards');
      if(!wrap){ go('survey'); return; }
      wrap.innerHTML = '';
      const variant = state.exp12fg.variant; // 'all_equal' | 'one_emph'
      const cards = ['A','B','C'].map((lab,i)=>({ id:['a','b','c'][i], title:`Paket ${lab}`, price:'9,99 € / Monat', desc:'Tools: Aufgaben, Notizen, Kalender, Freigaben' }));
      const emphId = cards[Math.floor(Math.random()*3)].id;
      state.exp12fg.extra = Object.assign({}, state.exp12fg.extra, { emphId, variant });
      cards.forEach(c=>{
        const isEmph = (variant==='one_emph' && c.id===emphId);
        const el = document.createElement('div');
        el.className = isEmph ? 'card card--halo' : 'card soft';
        el.innerHTML = `
          <div class="row between">
            <div class="plan__title">${c.title}</div>
            <div class="plan__price">${c.price}</div>
          </div>
          <div class="plan__desc">${c.desc}</div>
          <ul class="list small mt">
            <li>Unbegrenzte Projekte</li>
            <li>Grundlegende Analyse</li>
            <li>Support per E-Mail</li>
          </ul>
          <div class="divider"></div>
          <button type="button" class="btn btn-outline btn-block exp12fg-choose">Wählen</button>`;
        el.querySelectorAll('.exp12fg-choose').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            if(state.exp12fg.ttf==null) state.exp12fg.ttf = Math.round(now()-state.exp12fg.startedAt);
            state.exp12fg.clicks++; state.exp12fg.success=true; state.exp12fg.finishedAt=now();
            state.exp12fg.extra = Object.assign({}, state.exp12fg.extra, { clickedId: c.id });
            openAttribution({
              title:'Einordnung - Schritt 12',
              options:['Subtile Hervorhebung','Position','Gewohnheit','Sonstiges'],
              onDone:(reason)=>{ state.exp12fg.extra.reason=reason; go('exp12sd'); }
            });
          });
        });
        wrap.appendChild(el);
      });
    }

    // ===== EXP 13: Similarity vs. Dissimilarity =====
    function renderExp12sd(){
      const left = document.getElementById('exp12sd-left');
      const mid  = document.getElementById('exp12sd-mid');
      const right= document.getElementById('exp12sd-right');
      if(!left || !mid || !right){ go('survey'); return; }
      const v = state.exp12sd.variant; // 'soft_emph' | 'strong_emph' (immer min. 1 hervorgehoben)
      const emphPos = state.exp12sd.emphPos; // 'left' | 'middle' | 'right'
      // Reset classes
      [left,mid,right].forEach(b=> b.className = 'btn btn-outline');
      const applySoft = (b)=>{ b.className = 'btn btn-soft'; };
      const applyStrong = (b)=>{ b.className = 'btn btn-strong'; };
      const posEl = emphPos==='left'? left : emphPos==='middle'? mid : right;
      if(v==='strong_emph') applyStrong(posEl); else applySoft(posEl);

      const handler = (pos)=>{
        if(state.exp12sd.ttf==null) state.exp12sd.ttf = Math.round(now()-state.exp12sd.startedAt);
        state.exp12sd.clicks++; state.exp12sd.success=true; state.exp12sd.finishedAt=now();
        state.exp12sd.extra = { variant: v, emphPos, clickedPos: pos };
        openAttribution({
          title:'Einordnung - Schritt 13',
          options:['Gleiche Buttons','Leichte Abweichung','Starke Hervorhebung','Position','Sonstiges'],
            onDone:(reason)=>{ state.exp12sd.extra.reason = reason; go('exp14sp'); }
          });
      };
      left.onclick = ()=>handler('left');
      mid.onclick  = ()=>handler('middle');
      right.onclick= ()=>handler('right');
    }

    // ===== EXP 14: Social Proof – starke Hervorhebung =====
    const exp14spTargetId = ['reuse','basic','steel'][Math.floor(Math.random()*3)];
    const exp14spBannerCount = [260,310,355,402][Math.floor(Math.random()*4)];
    function renderExp14sp(){
      const grid = document.getElementById('exp14sp-grid'); if(!grid){ go('survey'); return; }
      grid.innerHTML = '';
      const order = [0,1,2].sort(()=>Math.random()-0.5);
      order.forEach(idx=>{
        const p = products[idx];
        const isTarget = p.id===exp14spTargetId;
        const card = document.createElement('div');
        // Karten alle mit gleichem oberen Innenabstand; Badge nur auf Zielkarte
        card.className = 'card soft pos-rel card--has-badge';
        const badge = isTarget ? `<div class=\"badge-pop-strong badge-top-left\">Beliebt heute, ${exp14spBannerCount} mal gekauft</div>` : '';
        card.innerHTML = `
          ${badge}
          <div class=\"muted small\">${p.subtitle}</div>
          <div class=\"thumb\"></div>
          <div class=\"item__name\">${p.name}</div>
          <div class=\"muted small\">${p.price.toFixed(2)}&nbsp;&euro;&nbsp;&nbsp;${p.rating.toFixed(1)}&#9733;&nbsp;&nbsp;Versand: ${p.shipping}</div>
          <button type=\"button\" class=\"btn mt\">In den Warenkorb</button>`;
        card.querySelector('button').addEventListener('click', ()=>{
          if(state.exp14sp.ttf==null) state.exp14sp.ttf = Math.round(now()-state.exp14sp.startedAt);
          state.exp14sp.clicks++; state.exp14sp.success=true; state.exp14sp.finishedAt=now();
          state.exp14sp.extra = { bannerChoices: isTarget?1:0, otherChoices: isTarget?0:1, targetName: products.find(pp=>pp.id===exp14spTargetId).name, bannerCount: exp14spBannerCount };
          openAttribution({
            title:'Einordnung - Schritt 14',
            options:['Beliebtheitshinweis','Starker Rahmen/Animation','Sonstiges'],
            onDone:(reason)=>{ state.exp14sp.extra.reason=reason; go('survey'); }
          });
        });
        grid.appendChild(card);
      });
    }

    // ===== EXP 15: Left Bias mit gleichen Karten =====
    function renderExp15left(){
      const wrap = document.getElementById('exp15-grid'); if(!wrap){ go('survey'); return; }
      wrap.innerHTML='';
      const cards = ['A','B','C'].map((lab,i)=>({ id:['left','middle','right'][i], title:`Paket ${lab}`, price:'9,99 € / Monat', desc:'Tools: Aufgaben, Notizen, Kalender, Freigaben' }));
      cards.forEach(c=>{
        const el = document.createElement('div');
        el.className = 'card soft';
        el.innerHTML = `
          <div class="row between">
            <div class="plan__title">${c.title}</div>
            <div class="plan__price">${c.price}</div>
          </div>
          <div class="plan__desc">${c.desc}</div>
          <ul class="list small mt">
            <li>Unbegrenzte Projekte</li>
            <li>Grundlegende Analyse</li>
            <li>Support per E-Mail</li>
          </ul>
          <div class="divider"></div>
          <button type="button" class="btn btn-outline btn-block exp15-choose">Wählen</button>`;
        el.querySelector('.exp15-choose').addEventListener('click', ()=>{
          if(state.exp15left.ttf==null) state.exp15left.ttf = Math.round(now()-state.exp15left.startedAt);
          state.exp15left.clicks++; state.exp15left.success=true; state.exp15left.finishedAt=now();
          state.exp15left.extra = { clickedPos: c.id };
          openAttribution({
            title:'Einordnung - Schritt 15',
            options:['Links','Mitte','Rechts','Sonstiges'],
            onDone:(reason)=>{ state.exp15left.extra.reason = reason; go('survey'); }
          });
        });
        wrap.appendChild(el);
      });
    }

    // ===== EXP 9pd: Progressive Disclosure =====
    function renderExp9pd(){
      const v = state.exp9pd.variant; // 'toggle' | 'all_open'
      const det = document.getElementById('exp9pd-details');
      if(v==='all_open') det.setAttribute('open',''); else det.removeAttribute('open');
      // Zwei gleichwertige Optionen (A/B) einfügen
      const card = document.getElementById('exp9pd-card');
      let opt = document.getElementById('exp9pd-opts');
      if(!opt){
        opt = document.createElement('div'); opt.id='exp9pd-opts'; opt.className='stack mt';
        opt.innerHTML = `
          <label class="radio-row"><input type="radio" name="p9opt" value="A"><span>Variante A</span></label>
          <label class="radio-row"><input type="radio" name="p9opt" value="B"><span>Variante B</span></label>`;
        card.insertBefore(opt, card.querySelector('.row.mt'));
      }
      const cta = document.getElementById('exp9pd-cta');
      cta.disabled = true; cta.classList.add('btn-disabled');
      let selected = null;
      opt.querySelectorAll('input[name="p9opt"]').forEach(r=>{
        r.addEventListener('change', (e)=>{
          selected = e.target.value;
          cta.disabled = false; cta.classList.remove('btn-disabled');
        });
      });
      let openCount = 0; let detailsOpened = v==='all_open';
      let openStart = v==='all_open' ? now() : null; let totalOpenMs = v==='all_open' ? 0 : 0;
      det.addEventListener('toggle', ()=>{
        detailsOpened = det.open; if(det.open){ openCount++; openStart = now(); } else { if(openStart!=null){ totalOpenMs += Math.max(0, now()-openStart); openStart=null; } }
      });
      document.getElementById('exp9pd-cta').onclick = ()=>{
        if(state.exp9pd.ttf==null) state.exp9pd.ttf = Math.round(now()-state.exp9pd.startedAt);
        state.exp9pd.clicks++; state.exp9pd.success=true; state.exp9pd.finishedAt=now();
        if(openStart!=null){ totalOpenMs += Math.max(0, now()-openStart); openStart=null; }
        state.exp9pd.extra = { detailsOpened, openCount, selected, openMs: Math.round(totalOpenMs) };
        go('exp9');
      };
    }

    // ===== EXP 7: Positionsbias =====
    function renderExp7(){
      const grid = document.getElementById('exp7-grid'); grid.innerHTML='';
      const leftFirst = state.exp7.variant==='left_target';
      const makeCard = ()=>{
        const d = document.createElement('div'); d.className='card soft';
        d.innerHTML = `<div class="thumb"></div><div class="item__name">Option</div><button class="btn mt">Wählen</button>`;
        return d;
      };
      const left = makeCard(); const right = makeCard();
      grid.appendChild(leftFirst? left : right);
      grid.appendChild(leftFirst? right : left);
      const clickHandler = (pos)=>{
        if(state.exp7.ttf==null) state.exp7.ttf = Math.round(now()-state.exp7.startedAt);
        state.exp7.clicks++; state.exp7.success=true; state.exp7.finishedAt=now();
        state.exp7.extra = { targetPos: leftFirst?'left':'right', clickedPos: pos };
          openAttribution({
            title:'Einordnung - Schritt 7',
            options: seenPosOptions(),
            onDone:(reason)=>{ state.exp7.extra.reason = reason; go('exp9b'); }
          });
      };
      left.querySelector('button').onclick = ()=>clickHandler('left');
      right.querySelector('button').onclick = ()=>clickHandler('right');
    }

    // ===== EXP 9: Feedback-Latenz & Mikro-Animation =====
    function renderExp9(){
      const btn = document.getElementById('exp9-cta');
      const v = state.exp9.variant; // 'none' | 'state' | 'state_motion'
      let clickCount = 0; let dblClicks = 0; let firstClickAt = null;
      const onDbl = ()=>{ dblClicks++; };
      btn.addEventListener('dblclick', onDbl);
      const WAIT_MS = (v==='none' ? 1500 : 150); // variant-spezifisches Fenster
      btn.onclick = ()=>{
        clickCount++;
        if(firstClickAt==null){ firstClickAt = now(); if(state.exp9.ttf==null) state.exp9.ttf = Math.round(firstClickAt - state.exp9.startedAt); }
        if(v==='state' || v==='state_motion') btn.classList.add('press-state');
        if(v==='state_motion'){
          btn.classList.add('press-animate');
          setTimeout(()=>btn.classList.remove('press-animate'), 140);
        }
      // Verlängertes Fenster, um Mehrfachklicks zu erfassen
        setTimeout(()=>{
          state.exp9.clicks = clickCount; state.exp9.success=true; state.exp9.finishedAt=now();
          state.exp9.extra = { feedback: v, clicks: clickCount, dblClicks, waitMs: WAIT_MS };
          try { btn.removeEventListener('dblclick', onDbl); } catch {}
          go('exp10');
        }, WAIT_MS);
      };
    }

    // ===== EXP 10: Inline vs Toast Validation =====
    function renderExp10(){
      const inline = state.exp10.variant==='inline';
      const email = document.getElementById('exp10-email');
      const pass = document.getElementById('exp10-pass');
      const emailErr = document.getElementById('exp10-email-err');
      const passErr = document.getElementById('exp10-pass-err');
      const passCount = document.getElementById('exp10-pass-count');
      const toast = document.getElementById('exp10-toast');
      const submit = document.getElementById('exp10-submit');
      // Anpassung: kein echter E-Mail-Test, sondern neutraler Benutzername
      const labels = document.querySelectorAll('#exp10-form .label');
      if(labels && labels[0]) labels[0].textContent = 'Eingabe (min. 3 Zeichen)';
      try { email.type = 'text'; email.placeholder = 'z. B. nutzer123'; emailErr.textContent = 'Mindestens 3 Zeichen.'; } catch {}
      const validUser = (v)=> (v||'').trim().length >= 3;
      let emailBad=true, passBad=true, corrections=0, errorsInline=0, errorsSubmit=0;
      // Rehydrate previously entered values
      try {
        const saved = (state.exp10.extra = state.exp10.extra || {});
        if(typeof saved.fieldValue === 'string'){ email.value = saved.fieldValue; }
        if(typeof saved.passValue === 'string'){ pass.value = saved.passValue; }
      } catch {}
      function valEmail(){ const bad = !validUser(email.value); if(inline){ emailErr.style.display= bad?'block':'none'; if(emailBad && !bad) corrections++; if(bad) errorsInline++; } emailBad = bad; }
      function valPass(){
        const len = (pass.value||'').length;
        const remain = Math.max(0, 6-len);
        if(passCount){ passCount.textContent = remain>0 ? `Noch ${remain} Zeichen` : 'OK'; }
        const bad = len<6;
        if(inline){ passErr.style.display= bad?'block':'none'; if(passBad && !bad) corrections++; if(bad) errorsInline++; }
        passBad = bad;
      }
      // Always persist values to state
      try { email.addEventListener('input', ()=>{ (state.exp10.extra = state.exp10.extra || {}).fieldValue = email.value; }); } catch {}
      try { pass.addEventListener('input',  ()=>{ (state.exp10.extra = state.exp10.extra || {}).passValue  = pass.value;  }); } catch {}
      if(inline){ email.addEventListener('input', valEmail); pass.addEventListener('input', valPass); }
      // initial counter update
      try { valPass(); } catch {}
      submit.onclick = ()=>{
        if(!inline){ emailErr.style.display='none'; passErr.style.display='none'; }
        valEmail(); valPass();
        if(emailBad || passBad){
          if(!inline){ errorsSubmit++; toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'), 1500); }
          return;
        }
        if(state.exp10.ttf==null) state.exp10.ttf = Math.round(now()-state.exp10.startedAt);
        state.exp10.clicks++; state.exp10.success=true; state.exp10.finishedAt=now();
        state.exp10.extra = Object.assign((state.exp10.extra||{}), { errorsInline, errorsSubmit, corrections });
        // Direktes Overlay fr Nutzungsfeedback, ohne den Screen zu wechseln
        openAttribution({
          title:'Wie angenehm war die Nutzung?',
          options:['Sehr unangenehm','Eher unangenehm','Neutral','Eher angenehm','Sehr angenehm'],
          onDone:(reason)=>{
            // Im exp11-Container protokollieren, aber nicht zu exp11 springen
            state.exp11 = state.exp11 || {};
            if(state.exp11.startedAt==null) state.exp11.startedAt = state.exp10.finishedAt;
            state.exp11.clicks = (state.exp11.clicks||0) + 1;
            state.exp11.success = true;
            state.exp11.finishedAt = now();
            state.exp11.extra = Object.assign((state.exp11.extra||{}), { pleasantness: reason });
            go('exp13');
          }
        });
      };
    }

    // ===== EXP 11: Weißraum =====
    function renderExp11(){
      // Modal-Feedback statt Grid, Hintergrundtext korrigieren
      try {
        const hintEl = document.querySelector('#screen-exp11 .hint');
        if(hintEl) hintEl.textContent = 'Bitte bewerten Sie kurz die Nutzung.';
        const g = document.getElementById('exp11-grid');
        if(g){ g.classList.add('hidden'); g.innerHTML=''; }
      } catch {}
      // Modal öffnen
      try {
        openAttribution({
          title:'Wie angenehm war die Nutzung?',
          options:['Sehr unangenehm','Eher unangenehm','Neutral','Eher angenehm','Sehr angenehm'],
          onDone:(reason)=>{
            if(state.exp11.ttf==null) state.exp11.ttf = Math.round(now()-state.exp11.startedAt);
            state.exp11.clicks++; state.exp11.success=true; state.exp11.finishedAt=now();
            state.exp11.extra = { pleasantness: reason };
            go('exp13');
          }
        });
        return;
      } catch {}
      const grid = document.getElementById('exp11-grid'); grid.innerHTML='';
      const primaryIdx = Math.floor(Math.random()*3);
      const halo = state.exp11.variant==='primary_white';
      for(let i=0;i<3;i++){
        const card = document.createElement('div');
        card.className = 'card soft' + (halo && i===primaryIdx ? ' card--halo' : '');
        card.innerHTML = `<div class=\"thumb\"></div><div class=\"item__name\">Karte</div><button class=\"btn mt\">Wählen</button>`;
        card.querySelector('button').onclick = ()=>{
          if(state.exp11.ttf==null) state.exp11.ttf = Math.round(now()-state.exp11.startedAt);
          state.exp11.clicks++; state.exp11.success=true; state.exp11.finishedAt=now();
          state.exp11.extra = { whiteSpacePrimary: halo, clickedPrimary: (i===primaryIdx) };
          go('exp13');
        };
        grid.appendChild(card);
      }
    }

    // ===== EXP 12: Sticky CTA =====
    function renderExp12(){ go('exp13'); return;
      // Drastisch gendert: Card-Emphasis (Schatten vs. Outline) als Einordnung im Overlay
      const emphShadow = state.exp12.variant==='emph_shadow';
      const emphLeft = state.exp12.emphLeft;
      if(state.exp12.ttf==null) state.exp12.ttf = Math.round(now()-state.exp12.startedAt);
      state.exp12.clicks++;
      openAttribution({
        title:'Was htte Ihre Wahl beeinflusst? (Aufgabe 12)',
        options:['Schatten (Hervorhebung)','Outline (Rahmen)','Position','Sonstiges'],
        onDone:(reason)=>{
          state.exp12.success=true; state.exp12.finishedAt=now();
          state.exp12.extra = { emphasis: emphShadow ? 'shadow' : 'outline', emphLeft, reason };
          go('exp13');
        }
      });
    }

    // Override EXP 12 to sichtbares Karten-Layout mit Overlay nach Klick
    /* try {
      renderExp12_disabled = function(){ go('exp13'); return;
        const section = document.getElementById('screen-exp12');
        if(section){ section.innerHTML = '<h2>Schritt 12<\/h2><p class="hint">Wählen Sie eine Karte.<\/p><div id="exp12-grid" class="grid grid-2"><\/div>'; }
        const grid = document.getElementById('exp12-grid'); if(!grid){ go('exp13'); return; }
        const emphShadow = state.exp12.variant==='emph_shadow';
        const emphLeft = state.exp12.emphLeft;
        const make = (emph)=>{ const d=document.createElement('div'); d.className = emph? 'card' : 'card soft'; d.innerHTML = '<div class="thumb"></div><div class="item__name">Karte</div><button class="btn mt">Wählen</button>'; return d; };
        const left = make(emphLeft ? emphShadow : !emphShadow);
        const right = make(!emphLeft ? emphShadow : !emphShadow);
        grid.appendChild(left); grid.appendChild(right);
        const handler = (pos)=>{
          if(state.exp12.ttf==null) state.exp12.ttf = Math.round(now()-state.exp12.startedAt);
          state.exp12.clicks++; state.exp12.success=true; state.exp12.finishedAt=now();
          state.exp12.extra = { emphasis: emphShadow ? 'shadow' : 'outline', emphLeft, clickedPos: pos };
          openAttribution({
            title:'Einordnung – Schritt 12',
            options:['Schatten','Outline','Position','Sonstiges'],
            onDone:(reason)=>{ state.exp12.extra.reason = reason; go('exp13'); }
          });
        };
        left.querySelector('button').onclick = ()=>handler('left');
        right.querySelector('button').onclick = ()=>handler('right');
      }
    } catch {} */

    // Override EXP 13 to Icon-vs-Text with two buttons + overlay
    /* try {
      renderExp13_override_disabled = function(){
        const section = document.getElementById('screen-exp13');
        if(section){ section.innerHTML = '<h2>Schritt 12<\/h2><p class="hint">Klicken Sie einen Button.<\/p><div class="row gap"><button id="exp13-left" type="button" class="btn btn-primary">Weiter<\/button><button id="exp13-right" type="button" class="btn btn-primary">Weiter<\/button><\/div>'; }
        const left = document.getElementById('exp13-left'); const right = document.getElementById('exp13-right');
        if(!left || !right){ go('survey'); return; }
        const iconLeft = !!state.exp13.iconLeft;
        const applyIcon = (el)=>{ el.innerHTML = '<span style="margin-right:6px">&#10003;<\/span>Weiter'; };
        if(iconLeft){ applyIcon(left); } else { applyIcon(right); }
        const handler = (pos)=>{
          if(state.exp13.ttf==null) state.exp13.ttf = Math.round(now()-state.exp13.startedAt);
          state.exp13.clicks++; state.exp13.success=true; state.exp13.finishedAt=now();
          state.exp13.extra = { iconPos: iconLeft?'left':'right', clickedPos: pos };
          openAttribution({
            title:'Einordnung - Schritt 12',
            options:['Icon/Haken','Nur Text','Position','Sonstiges'],
            onDone:(reason)=>{ state.exp13.extra.reason=reason; go('survey'); }
          });
        };
        left.onclick = ()=>handler('left');
        right.onclick = ()=>handler('right');
      }
    } catch {} */

    // Re-Override EXP 12 to sticky vs. inline (vermeidet Duplikat zu Schritt 3)
    /* try {
      renderExp12_disabled2 = function(){ go('exp13'); return;
        const v = state.exp12.variant; // 'sticky' | 'inline'
        const inlineBtn = document.getElementById('exp12-inline');
        const stickyBar = document.getElementById('exp12-sticky');
        const stickyBtn = document.getElementById('exp12-sticky-btn');

        const useSticky = (v === 'sticky');
        if(useSticky){
          if(inlineBtn) inlineBtn.classList.add('hidden');
          if(stickyBar) stickyBar.classList.remove('hidden');
        } else {
          if(inlineBtn) inlineBtn.classList.remove('hidden');
          if(stickyBar) stickyBar.classList.add('hidden');
        }

        const onClick = (type)=>{
          if(state.exp12.ttf==null) state.exp12.ttf = Math.round(now()-state.exp12.startedAt);
          state.exp12.clicks++; state.exp12.success=true; state.exp12.finishedAt=now();
          state.exp12.extra = { cta: type, variant: v };
          openAttribution({
            title:'Einordnung – Schritt 12',
            options:['Sticky-Leiste','Inline-Button','Position (oben/unten)','Sonstiges'],
            onDone:(reason)=>{ state.exp12.extra.reason = reason; go('exp13'); }
          });
        };

        if(inlineBtn) inlineBtn.onclick = ()=>onClick('inline');
        if(stickyBtn) stickyBtn.onclick = ()=>onClick('sticky');
      }
    } catch {} */

    // ===== Override: Exp 5 material logic =====
    /* try {
      renderExp5_override_disabled = function(){
        const scarcePresent = state.exp5.variant==='scarce_present';
        const scarceLeft = state.exp5.scarceLeft;
        const materialA = 'Plastik';
        const materialB = 'Plastik';
        const recommendNote = `<div class="muted small">Empfohlen von 92% der Kunden</div>`;
        const a = document.getElementById('exp5-a');
        const b = document.getElementById('exp5-b');
        if(!a || !b){ return; }
        a.innerHTML = `
          <div class="item__name">Variante A  Trinkflasche  ${materialA}</div>
          ${ scarcePresent && scarceLeft ? recommendNote : '' }
          <div class="muted">Volumen: 750 ml  Gewicht: 180 g</div>
          <div class="muted">Material: ${materialA} (BPA-frei)</div>
          <div class="muted">Preis: 19,90 €   Bewertung: 4,4 ★</div>
          <div class="muted mb">Versand: 2-3 Tage</div>
          <ul class="list small mb"><li>Auslaufsicherer Deckel</li><li>Spülmaschinenfest</li></ul>
          <button id="exp5-select-a" type="button" class="btn btn-outline">Auswählen</button>`;
        b.innerHTML = `
          <div class="item__name">Variante B  Trinkflasche  ${materialB}</div>
          ${ scarcePresent && !scarceLeft ? recommendNote : '' }
          <div class="muted">Volumen: 750 ml  Gewicht: 180 g</div>
          <div class="muted">Material: ${materialB} (BPA-frei)</div>
          <div class="muted">Preis: 19,90 €   Bewertung: 4,4 ★</div>
          <div class="muted mb">Versand: 2-3 Tage</div>
          <ul class="list small mb"><li>Auslaufsicherer Deckel</li><li>Spülmaschinenfest</li></ul>
          <button id="exp5-select-b" type="button" class="btn btn-outline">Auswählen</button>`;
        document.getElementById('exp5-select-a').onclick = ()=>{
          if(state.exp5.ttf==null) state.exp5.ttf = Math.round(now()-state.exp5.startedAt);
          state.exp5.clicks++; state.exp5.success=true; state.exp5.finishedAt=now();
          const selA = 'A_plastik';
          state.exp5.extra = { selected: selA, recommendShown: scarcePresent && scarceLeft, cueSide: scarceLeft?'A':'B' };
          openAttribution({ title:'Kurze Einordnung - Schritt 5', options:['Empfehlungshinweis','Position','Sonstiges'], onDone:(reason)=>{ state.exp5.extra.reason=reason; go('exp2b'); } });
        };
        document.getElementById('exp5-select-b').onclick = ()=>{
          if(state.exp5.ttf==null) state.exp5.ttf = Math.round(now()-state.exp5.startedAt);
          state.exp5.clicks++; state.exp5.success=true; state.exp5.finishedAt=now();
          state.exp5.extra = { selected:'B_plastik', recommendShown: scarcePresent && !scarceLeft, cueSide: scarceLeft?'A':'B' };
          openAttribution({ title:'Kurze Einordnung - Schritt 5', options:['Empfehlungshinweis','Position','Sonstiges'], onDone:(reason)=>{ state.exp5.extra.reason=reason; go('exp2b'); } });
        };
      };
    } catch {} */

    // ===== Export/Submit =====
    function payload(){
      const dur = state.startedAt? Math.round(now()-state.startedAt):0;
      return { condition:CONDITION, client:CLIENT, startedAt:state.startedAt, durationMs:dur, exp1:state.exp1, exp2:state.exp2, exp3:state.exp3, exp4:state.exp4, exp4pref:state.exp4pref, exp5:state.exp5, exp2b:state.exp2b, exp6:state.exp6, exp6chk:state.exp6chk, exp7:state.exp7, exp8:state.exp8, exp9b:state.exp9b, exp10icon:state.exp10icon, exp11gc:state.exp11gc, exp12fg:state.exp12fg, exp12sd:state.exp12sd, exp14sp:state.exp14sp, exp15left:state.exp15left, survey:state.survey, events:state.events };
    }
    async function submit(){
      const out = $('#submit-status');
      const btn = $('#btn-submit');

      if(!COLLECT_URL){
        out.textContent = 'Kein COLLECT_URL konfiguriert.';
        return;
      }

      try {
        btn.disabled = true;
        btn.classList.add('btn-disabled');
        btn.textContent = 'Sende …';
        out.textContent = '';

        const res = await fetch(COLLECT_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload())
        });

        if(!res.ok){
          throw new Error('HTTP '+res.status);
        }

        btn.textContent = 'Gesendet';
        out.textContent = 'Vielen Dank – die Ergebnisse wurden erfolgreich übermittelt.';
      } catch(e){
        btn.disabled = false;
        btn.classList.remove('btn-disabled');
        btn.textContent = 'Ergebnisse senden';
        out.textContent = 'Fehler beim Senden: ' + (e && e.message ? e.message : e);
      }
    }

    // ===== EXP 13: CTA Icon vs. Text =====
    function renderExp13(){
      const btn = document.getElementById('exp13-cta');
      if(!btn){ go('survey'); return; }
      const v = state.exp13.variant; // 'generic' | 'actionable'
      btn.textContent = v==='actionable' ? 'Jetzt abschließen' : 'Weiter';
      btn.onclick = ()=>{
        if(state.exp13.ttf==null) state.exp13.ttf = Math.round(now()-state.exp13.startedAt);
        state.exp13.clicks++; state.exp13.success=true; state.exp13.finishedAt=now();
        state.exp13.extra = { copy: v };
        go('survey');
      };
    }

    // ===== Summary =====
    function renderSummary(){
      const s = $('#summary'); s.innerHTML='';
      const add = (t)=>{ const li=document.createElement('li'); li.textContent=t; s.appendChild(li); };
      add('Bedingung: '+CONDITION);
      add('Exp1: Klick auf '+(state.exp1.extra.clickedCard||'')+'  Target '+(state.exp1.extra.targetId||'')+'  isTarget '+String(state.exp1.extra.isTarget||''));
      add('Exp2: Klick '+(state.exp2.extra.clicked||'')+'  Pos '+(state.exp2.extra.clickedPos||''));
      add('Exp3: Banner-Wahl '+(state.exp3.extra.bannerChoices||0)+'  Andere '+(state.exp3.extra.otherChoices||0)+'  Target '+(state.exp3.extra.targetName||''));
      add('Exp4: Default '+(state.exp4.extra.defaultOption||'')+'  Gewählt '+(state.exp4.extra.selectedOption||'')+'  Adopted '+String(state.exp4.extra.adopted||false));
      add('Exp5: Klick-Position '+(state.exp5.extra.clickedPos||''));
    }

    // ===== Wire global buttons =====
    $('#btn-submit').onclick = submit;
    // Back navigation
    const backBtn = document.getElementById('btn-back');
    if(backBtn){
      backBtn.addEventListener('click', ()=>{
        // if overlay open, dismiss it first
        const attr = document.getElementById('attr');
        if(attr && !attr.classList.contains('hidden')){ dismissAttribution(); }
        const idx = screens.indexOf(state.step);
        if(idx > 0){ go(screens[idx-1]); }
      });
    }

    // Start button state init
    $('#consent').dispatchEvent(new Event('change'));
  </script>
</body>
</html>
<!-- hello -->


